// Generated by CoffeeScript 1.6.3
(function() {
  var BaseModel, Email, privKey,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __slice = [].slice;

  BaseModel = (function() {
    function BaseModel() {}

    BaseModel.prototype.humanize = function(keys) {
      var key, swap, _i, _len, _results,
        _this = this;
      swap = function(key) {
        return _this['_' + key] = _this[key];
      };
      _results = [];
      for (_i = 0, _len = keys.length; _i < _len; _i++) {
        key = keys[_i];
        _results.push(swap(key));
      }
      return _results;
    };

    BaseModel.prototype.dehumanize = function(keys) {
      var key, swap, _i, _len, _results,
        _this = this;
      swap = function(key) {
        if (_this['_' + key] == null) {
          return;
        }
        delete _this[key];
        _this[key] = _this['_' + key];
        return delete _this['_' + key];
      };
      _results = [];
      for (_i = 0, _len = keys.length; _i < _len; _i++) {
        key = keys[_i];
        _results.push(swap(key));
      }
      return _results;
    };

    return BaseModel;

  })();

  Email = (function(_super) {
    __extends(Email, _super);

    function Email(id, email, _key) {
      var _ref, _ref1, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7;
      this.id = id;
      this._key = _key;
      this.user = (_ref = email != null ? email.user : void 0) != null ? _ref : null;
      this.date = (_ref1 = email != null ? email.date : void 0) != null ? _ref1 : null;
      this.from = (_ref2 = email != null ? email.from : void 0) != null ? _ref2 : null;
      this.subject = (_ref3 = email != null ? email.subject : void 0) != null ? _ref3 : null;
      this.body = (_ref4 = email != null ? email.body : void 0) != null ? _ref4 : null;
      this.signature = (_ref5 = email != null ? email.signature : void 0) != null ? _ref5 : null;
      this.pubKey = (_ref6 = email != null ? email.pubKey : void 0) != null ? _ref6 : null;
      this.read = (_ref7 = email != null ? email.read : void 0) != null ? _ref7 : false;
    }

    Email.prototype.sign = function(signingKey) {
      var corpus;
      corpus = {
        subject: this._subject,
        body: this._body
      };
      corpus = sjcl.hash.sha256.hash(JSON.stringify(corpus));
      this.signature = signingKey.sign(corpus, 10);
      return this.signature = sjcl.codec.base64.fromBits(this.signature);
    };

    Email.prototype.verify = function() {
      var corpus, ok;
      corpus = {
        subject: this._subject,
        body: this._body
      };
      corpus = sjcl.hash.sha256.hash(JSON.stringify(corpus));
      ok = this.pubKey.ecdsa.verify(corpus, sjcl.codec.base64.toBits(this.signature));
      return ok;
    };

    Email.prototype.humanize = function() {
      Email.__super__.humanize.call(this, ['from', 'subject', 'body', 'pubKey']);
      this._decrypted = {
        from: null,
        subject: null,
        body: null,
        pubKey: null
      };
      this.__defineGetter__('from', function() {
        if (this._decrypted.from == null) {
          this._decrypted.from = sjcl.decrypt(this._key, this._from);
        }
        return this._decrypted.from;
      });
      this.__defineSetter__('from', function(from) {
        this._decrypted.from = from;
        return this._from = sjcl.encrypt(this._key, from);
      });
      this.__defineGetter__('subject', function() {
        if (this._decrypted.subject == null) {
          this._decrypted.subject = sjcl.decrypt(this._key, this._subject);
        }
        return this._decrypted.subject;
      });
      this.__defineSetter__('subject', function(subject) {
        this._decrypted.subject = subject;
        return this._subject = sjcl.encrypt(this._key, subject);
      });
      this.__defineGetter__('body', function() {
        if (this._decrypted.body == null) {
          this._decrypted.body = sjcl.decrypt(this._key, this._body);
        }
        return this._decrypted.body;
      });
      this.__defineSetter__('body', function(body) {
        this._decrypted.body = body;
        return this._body = sjcl.encrypt(this._key, body);
      });
      this.__defineGetter__('pubKey', function() {
        var pub;
        if (this._decrypted.pubKey == null) {
          pub = JSON.parse(sjcl.decrypt(this._key, this._pubKey));
          pub.elGamal = sjcl.ecc.deserialize(pub.elGamal);
          pub.ecdsa = sjcl.ecc.deserialize(pub.ecdsa);
          this._decrypted.pubKey = pub;
        }
        return this._decrypted.pubKey;
      });
      return this.__defineSetter__('pubKey', function(pubKey) {
        if (!typeof pubKey === 'string') {
          pubKey = JSON.stringify(pubKey);
        }
        this._decrypted.pubKey = pubKey;
        return this._pubKey = sjcl.encrypt(this._key, pubKey);
      });
    };

    Email.prototype.dehumanize = function() {
      return Email.__super__.dehumanize.call(this, ['from', 'subject', 'body', 'pubKey']);
    };

    return Email;

  })(BaseModel);

  /* Functions to secure forms.*/


  window.signin = function(form) {
    var pass;
    pass = form.pass.value;
    window.localStorage.pass = pass;
    form.pass.value = sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(pass));
    return true;
  };

  window.register = function(form) {
    var ecdsa, elGamal, pass, privKey, pubKey;
    pass = form.pass.value;
    window.localStorage.pass = pass;
    form.pass.value = sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(pass));
    elGamal = sjcl.ecc.elGamal.generateKeys(256, 10);
    ecdsa = sjcl.ecc.ecdsa.generateKeys(256, 10);
    pubKey = {
      elGamal: elGamal.pub.serialize(),
      ecdsa: ecdsa.pub.serialize()
    };
    form.pubKey.value = JSON.stringify(pubKey);
    privKey = {
      elGamal: elGamal.sec.serialize(),
      ecdsa: ecdsa.sec.serialize()
    };
    privKey = {
      email: privKey,
      search: {}
    };
    form.privKey.value = sjcl.encrypt(pass, JSON.stringify(privKey));
    return true;
  };

  window.changePassword = function(form) {
    var pass, privKey;
    privKey = sjcl.decrypt(window.localStorage.pass, form.privKey.value);
    pass = form.pass.value;
    window.localStorage.pass = pass;
    form.pass.value = sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(pass));
    form.privKey.value = sjcl.encrypt(window.localStorage.pass, privKey);
    return true;
  };

  window.compose = function(form) {
    var curve, e, email, encryptionKey, pub;
    try {
      if (window.toPubKey == null) {
        throw 'Invalid destination address.';
      }
      pub = JSON.parse(window.toPubKey);
      curve = sjcl.ecc.curves.c256;
      encryptionKey = sjcl.ecc.deserialize(pub.elGamal);
      email = new Email(null, null, encryptionKey);
      email.humanize();
      email.from = window.from;
      email.subject = form.subject.value;
      email.body = form.body.value;
      email.pubKey = window.pubKey;
      email.sign(window.privKey.ecdsa);
      email.dehumanize();
      form.from.value = email.from;
      form.subject.value = email.subject;
      form.body.value = email.body;
      form.signature.value = email.signature;
      form.pubKey.value = email.pubKey;
      return true;
    } catch (_error) {
      e = _error;
      alert(e);
      return false;
    }
  };

  window.view = function(id) {
    var corpus, email, footer, k, key, max, o, tokens, v, _ref;
    email = window.cache[id];
    footer = 'From ' + email.from + ' on ' + email.date;
    $('#view-subj').text(email.subject);
    $('#view-body').text(email.body);
    $('#view-footer').text(footer);
    $('#view').modal();
    if (!email.read) {
      document.getElementById(email.id).className = '';
      corpus = email.from + ' ' + email.subject + ' ' + email.body;
      max = corpus.length;
      tokens = sjcl.searchable.tokenize(corpus);
      o = sjcl.searchable.secureIndex(window.searchKeys, max, tokens);
      o.index.docs = [email.id];
      _ref = o.index.index;
      for (k in _ref) {
        v = _ref[k];
        if (v === o.newId) {
          o.index.index[k] = email.id;
        }
      }
      key = {
        search: window.searchKeys,
        email: {
          elGamal: window.privKey.elGamal.serialize(),
          ecdsa: window.privKey.ecdsa.serialize()
        }
      };
      key = sjcl.encrypt(window.localStorage.pass, JSON.stringify(key));
      return window.socket.emit('index', email.id, o.newDomain, [], o.index, key);
    }
  };

  /* Manage server interactions*/


  window.getPubKey = function(input) {
    var statusIcon, _ref;
    if (window.socket == null) {
      return alert('Could not contact server!');
    }
    if (window.to === input.value) {
      return;
    }
    _ref = [input.value, null], window.to = _ref[0], window.toPubKey = _ref[1];
    statusIcon = document.getElementById('to-status-icon');
    statusIcon.className = 'glyphicon glyphicon-refresh';
    window.socket.emit('pubKey', input.value);
    return window.socket.once('pubKey', function(pubKey) {
      if (pubKey !== false) {
        statusIcon.className = 'glyphicon glyphicon-ok';
        return window.toPubKey = pubKey;
      } else {
        return statusIcon.className = 'glyphicon glyphicon-remove';
      }
    });
  };

  if (window.privKey != null) {
    privKey = JSON.parse(sjcl.decrypt(window.localStorage.pass, window.privKey));
    window.searchKeys = privKey.search;
    privKey = privKey.email;
    privKey.elGamal = sjcl.ecc.deserialize(privKey.elGamal);
    privKey.ecdsa = sjcl.ecc.deserialize(privKey.ecdsa);
    window.privKey = privKey;
    window.socket = io.connect('http://localhost:3000');
    window.socket.emit('login', window.tag);
    window.socket.on('authed', function() {
      return window.socket.emit('page', 1);
    });
  }

  window.socket.on('page', function(emails) {
    var loadEmail;
    loadEmail = function(i) {
      var c, cb, email, err, tr;
      if (emails[i] == null) {
        return $('#loading').hide('fast');
      }
      email = new Email(emails[i].id, emails[i], window.privKey.elGamal);
      email.humanize();
      window.cache[email.id] = email;
      try {
        email.verify();
      } catch (_error) {
        err = _error;
        err = true;
      }
      c = err != null ? 'danger' : !email.read ? 'warning' : '';
      cb = 'window.view(\'' + email.id + '\')';
      tr = '<tr id="' + email.id + '" onclick="' + cb + '" ';
      tr = tr + 'style="display: none" class="' + c + '">';
      tr = tr + '<td id="from-' + email.id + '"></td>';
      tr = tr + '<td id="subj-' + email.id + '"></td>';
      tr = tr + '<td id="date-' + email.id + '"></td></tr>';
      $('#emails tr:last').after(tr);
      $('#from-' + email.id).text(email.from);
      $('#subj-' + email.id).text(email.subject);
      $('#date-' + email.id).text(email.date);
      return $('#' + email.id).show(1000, function() {
        return loadEmail(i + 1);
      });
    };
    if (emails.length !== 0) {
      return $('#emails').show('fast', function() {
        return loadEmail(0);
      });
    } else {
      return $('#error').show('fast', function() {
        return $('#loading').hide('fast');
      });
    }
  });

  window.socket.on('index', function(newId, reps, emails) {
    var corpus, email, err, index, indexes, key, max, out, token, tokens, _i, _j, _len, _len1, _ref, _ref1;
    _ref = [0, []], max = _ref[0], indexes = _ref[1];
    for (_i = 0, _len = emails.length; _i < _len; _i++) {
      email = emails[_i];
      index = {};
      email = new Email(email.id, email, window.privKey.elGamal);
      try {
        email.verify();
      } catch (_error) {
        err = _error;
        continue;
      }
      corpus = email.from + ' ' + email.subject + ' ' + email.body;
      if (corpus.length > max) {
        max = corpus.length;
      }
      tokens = sjcl.searchable.tokenize(corpus);
      for (_j = 0, _len1 = tokens.length; _j < _len1; _j++) {
        token = tokens[_j];
        index[token] = email.id;
      }
      indexes.push(index);
    }
    out = (_ref1 = sjcl.searchable).secureIndex.apply(_ref1, [window.searchKeys, max].concat(__slice.call(indexes)));
    key = {
      search: window.searchKeys,
      email: {
        elGamal: window.privKey.elGamal.serialize(),
        ecdsa: window.privKey.ecdsa.serialize()
      }
    };
    key = sjcl.encrypt(window.localStorage.pass, JSON.stringify(key));
    return window.socket.emit('index', newId, out.newDomain, reps, out.index, key);
  });

}).call(this);
